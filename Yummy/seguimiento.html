<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento del Pedido - Diamonds Coffee</title>
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Segoe, "Segoe UI", "DejaVu Sans", "Trebuchet MS", Verdana, "sans-serif";
            background: #25282d;
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #e5b652, #d4a54a);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .container-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: calc(100vh - 80px);
        }

        .back-button {
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #e5b652;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #d4a54a;
            color: white;
            text-decoration: none;
        }

        .pedido-header {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 5px solid #e5b652;
        }

        .pedido-id {
            font-size: 24px;
            font-weight: bold;
            color: #e5b652;
            margin-bottom: 10px;
        }

        .pedido-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .timeline-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .timeline {
            position: relative;
            padding-left: 0;
        }

        .timeline-item {
            position: relative;
            padding: 25px 0 25px 80px;
            border-left: 3px solid #eee;
            margin-bottom: 20px;
        }

        .timeline-item.completed {
            border-left-color: #27ae60;
        }

        .timeline-item.active {
            border-left-color: #e5b652;
            background: linear-gradient(90deg, rgba(229, 182, 82, 0.05), transparent);
        }

        .timeline-icon {
            position: absolute;
            left: -20px;
            top: 30px;
            width: 40px;
            height: 40px;
            background: #eee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }

        .timeline-item.completed .timeline-icon {
            background: #27ae60;
            color: white;
        }

        .timeline-item.active .timeline-icon {
            background: #e5b652;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(229, 182, 82, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(229, 182, 82, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(229, 182, 82, 0);
            }
        }

        .timeline-content {
            background: white;
        }

        .timeline-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .timeline-time {
            font-size: 14px;
            color: #e5b652;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .timeline-description {
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .timeline-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e5b652;
        }

        .delivery-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-top: 4px solid #e5b652;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delivery-person {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .delivery-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #e5b652, #d4a54a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .delivery-details h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 16px;
        }

        .delivery-details p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .vehicle-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .vehicle-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .vehicle-detail:last-child {
            margin-bottom: 0;
        }

        .map-container {
            height: 300px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .map-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #e74c3c;
            border-radius: 50%;
            border: 3px solid white;
            animation: bounce 1s infinite;
        }

        .marker-delivery {
            top: 40%;
            left: 60%;
        }

        .marker-destination {
            top: 70%;
            left: 30%;
            background: #3498db;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .eta-info {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #e5b652, #d4a54a);
            color: white;
            border-radius: 12px;
            margin: 20px 0;
        }

        .eta-time {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .eta-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .btn-primary {
            background: #e5b652;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #d4a54a;
        }

        .btn-danger {
            background: #e74c3c;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-outline-primary {
            border: 2px solid #e5b652;
            color: #e5b652;
            background: transparent;
            padding: 10px 23px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: #e5b652;
            color: white;
        }

        .notification-panel {
            background: #fff3cd;
            height: 150px;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .notification-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-message {
            color: #856404;
            margin: 0;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .summary-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #e5b652;
            font-size: 18px;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid #eee;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #d4edda;
            color: #155724;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        @media (max-width: 768px) {
            .delivery-info {
                grid-template-columns: 1fr;
            }

            .timeline-item {
                padding-left: 60px;
            }

            .timeline-icon {
                width: 30px;
                height: 30px;
                left: -15px;
                font-size: 14px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .container-main {
                padding: 15px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .success-icon {
            color: #27ae60;
        }

        .warning-icon {
            color: #f39c12;
        }

        .error-icon {
            color: #e74c3c;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Seguimiento de Pedido</h1>
        <p>Diamonds Coffee - Seguimiento en tiempo real</p>
    </div>

    <div class="container-main">
        <a href="envio.html" class="back-button">
            <i class="bi bi-arrow-left"></i> Volver al formulario
        </a>

        <div class="live-indicator">
            <span class="live-dot"></span>
            Seguimiento en vivo - Actualizado hace 30 seg
        </div>

        <!-- Header del Pedido -->
        <div class="pedido-header">
            <div class="pedido-id">Pedido #DC-2024-001547</div>
            <p class="mb-0">Tu pedido está siendo preparado con cuidado</p>
            <div class="pedido-info">
                <div class="info-item">
                    <span class="info-label">Fecha del Pedido</span>
                    <span class="info-value" id="fecha-pedido">04 Ago 2025, 14:30</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Método de Pago</span>
                    <span class="info-value" id="metodo-pago">Efectivo</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total</span>
                    <span class="info-value" id="total-pedido">$19.98</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Estado</span>
                    <span class="info-value" id="estado-pedido" style="color: #e5b652; font-weight: bold;">En
                        Preparación</span>
                </div>
            </div>
        </div>

        <!-- Notificación para efectivo -->
        <div class="notification-panel" id="notificacion-efectivo">
            <div class="notification-title">
                <i class="bi bi-info-circle"></i>
                Pago en Efectivo
            </div>
            <p class="notification-message">
                Se ha notificado al repartidor que el pago será en efectivo. Prepara el monto exacto:
                <strong>$19.98</strong>
            </p>
        </div>

        <div class="action-buttons">
            <button class="btn btn-danger" onclick="cancelarPedido()" id="btn-cancelar">
                <i class="bi bi-x-circle"></i> Cancelar Pedido
            </button>
        </div>

        <!-- Timeline del Pedido -->
        <div class="timeline-container">
            <h3 class="mb-4">Progreso del Pedido</h3>
            <div class="timeline">
                <div class="timeline-item completed" id="step-confirmado">
                    <div class="timeline-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="timeline-content">
                        <h4 class="timeline-title">Pedido Confirmado</h4>
                        <div class="timeline-time">14:30 - Hace 25 minutos</div>
                        <p class="timeline-description">
                            Tu pedido ha sido recibido y confirmado exitosamente.
                        </p>
                        <div class="timeline-details">
                            <strong>Personal:</strong> María González (Recepción)<br>
                            <strong>Acción:</strong> Pedido registrado en el sistema
                        </div>
                    </div>
                </div>

                <div class="timeline-item active" id="step-preparacion">
                    <div class="timeline-icon">
                        <i class="bi bi-gear-fill"></i>
                    </div>
                    <div class="timeline-content">
                        <h4 class="timeline-title">En Preparación</h4>
                        <div class="timeline-time">14:35 - Hace 20 minutos</div>
                        <p class="timeline-description">
                            Nuestros baristas están preparando tu pedido con los mejores ingredientes.
                        </p>
                        <div class="timeline-details">
                            <strong>Personal:</strong> Carlos Mendoza (Barista Principal)<br>
                            <strong>Tiempo estimado:</strong> 15-20 minutos<br>
                            <strong>Estado del inventario:</strong> ✅ Todos los ingredientes disponibles
                        </div>
                    </div>
                </div>

                <div class="timeline-item" id="step-entrega">
                    <div class="timeline-icon">
                        <i class="bi bi-truck"></i>
                    </div>
                    <div class="timeline-content">
                        <h4 class="timeline-title">En Camino</h4>
                        <div class="timeline-time">Próximamente</div>
                        <p class="timeline-description">
                            Tu pedido será enviado con nuestro repartidor de confianza.
                        </p>
                        <div class="timeline-details">
                            <strong>Repartidor asignado:</strong> Pendiente<br>
                            <strong>Tiempo estimado de entrega:</strong> 25-35 minutos
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ETA -->
        <div class="eta-info" id="eta-container">
            <div class="eta-time" id="eta-time">20 min</div>
            <div class="eta-label">Tiempo estimado de entrega</div>
        </div>

        <!-- Información del Delivery -->
        <div class="delivery-info" id="delivery-section" style="display: none;">
            <div class="info-card">
                <h3 class="card-title">
                    <i class="bi bi-person-circle"></i>
                    Tu Repartidor
                </h3>
                <div class="delivery-person">
                    <div class="delivery-avatar" id="delivery-avatar">
                        JR
                    </div>
                    <div class="delivery-details">
                        <h4 id="delivery-name">Juan Rodríguez</h4>
                        <p id="delivery-rating">⭐ 4.8 (127 entregas)</p>
                        <p id="delivery-phone">📞 0987-654-321</p>
                    </div>
                </div>
                <div class="vehicle-info">
                    <div class="vehicle-detail">
                        <span><strong>Vehículo:</strong></span>
                        <span id="vehicle-type">Motocicleta</span>
                    </div>
                    <div class="vehicle-detail">
                        <span><strong>Placa:</strong></span>
                        <span id="vehicle-plate">ABC-1234</span>
                    </div>
                    <div class="vehicle-detail">
                        <span><strong>Color:</strong></span>
                        <span id="vehicle-color">Rojo</span>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3 class="card-title">
                    <i class="bi bi-geo-alt-fill"></i>
                    Ubicación en Tiempo Real
                </h3>
                <div class="map-container" id="map-container">
                    <div class="map-marker marker-delivery"></div>
                    <div class="map-marker marker-destination"></div>
                    📍 Rastreando ubicación del repartidor...
                </div>
                <p class="text-center mb-0">
                    <small class="text-muted">🔴 Repartidor | 🔵 Tu ubicación</small>
                </p>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="contactarRepartidor()" id="btn-contactar" style="display: none;">
                <i class="bi bi-telephone"></i> Contactar Repartidor
            </button>
            <button class="btn btn-outline-primary" onclick="verResumenPedido()">
                <i class="bi bi-receipt"></i> Ver Resumen del Pedido
            </button>
        </div>

        <!-- Resumen del Pedido (inicialmente oculto) -->
        <div class="order-summary" id="order-summary" style="display: none;">
            <h3 class="summary-title">Resumen del Pedido</h3>
            <div class="order-item">
                <span>2x Cappuccino Grande</span>
                <span>$8.00</span>
            </div>
            <div class="order-item">
                <span>1x Croissant de Chocolate</span>
                <span>$4.50</span>
            </div>
            <div class="order-item">
                <span>1x Muffin de Arándanos</span>
                <span>$3.50</span>
            </div>
            <div class="order-item">
                <span>Costo de envío</span>
                <span>$1.50</span>
            </div>
            <div class="order-item">
                <span>Total</span>
                <span>$19.25</span>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="modal-cancelacion" class="modal">
        <div class="modal-content">
            <div class="modal-icon warning-icon">⚠️</div>
            <h3>¿Confirmar Cancelación?</h3>
            <p>¿Estás seguro de que deseas cancelar tu pedido?</p>
            <p><small>Si ya fue pagado con tarjeta, se procesará la devolución en 3-5 días hábiles.</small></p>
            <div class="mt-3">
                <button class="btn btn-danger me-2" onclick="confirmarCancelacion()">Sí, Cancelar</button>
                <button class="btn btn-outline-primary" onclick="cerrarModal('modal-cancelacion')">No, Mantener</button>
            </div>
        </div>
    </div>

    <div id="modal-confirmacion" class="modal">
        <div class="modal-content">
            <div class="modal-icon success-icon">✅</div>
            <h3 id="modal-title">Acción Completada</h3>
            <p id="modal-message">La acción se ha completado exitosamente.</p>
            <button class="btn btn-primary" onclick="cerrarModal('modal-confirmacion')">Entendido</button>
        </div>
    </div>

    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. MODIFICAR en seguimiento.html - Variables globales para controlar simulaciones
        let estadoActual = 1;
        let tiempoRestante = 20;
        let repartidorAsignado = false;
        let simulacionActiva = true; // Nueva variable para controlar simulaciones
        let intervalosActivos = []; // Array para almacenar referencias de intervalos
        let timeoutsActivos = []; // Array para almacenar referencias de timeouts

        // 2. MODIFICAR en seguimiento.html - Función para detener todas las simulaciones
        function detenerSimulaciones() {
            simulacionActiva = false;

            // Limpiar todos los intervalos
            intervalosActivos.forEach(intervalo => clearInterval(intervalo));
            intervalosActivos = [];

            // Limpiar todos los timeouts
            timeoutsActivos.forEach(timeout => clearTimeout(timeout));
            timeoutsActivos = [];

            console.log('🛑 Todas las simulaciones han sido detenidas');
        }

        // 3. MODIFICAR en seguimiento.html - Función simularProgresoPedido() mejorada
        function simularProgresoPedido() {
            if (!simulacionActiva) return;

            // Simular el avance del pedido con timeouts controlados
            const timeout1 = setTimeout(() => {
                if (simulacionActiva && estadoActual === 1) {
                    avanzarAPreparacion();
                }
            }, 5000);
            timeoutsActivos.push(timeout1);

            const timeout2 = setTimeout(() => {
                if (simulacionActiva && estadoActual === 2) {
                    avanzarAEntrega();
                }
            }, 15000);
            timeoutsActivos.push(timeout2);
        }

        // 4. MODIFICAR en seguimiento.html - Función simularMovimientoRepartidor() mejorada
        function simularMovimientoRepartidor() {
            if (!simulacionActiva) return;

            const marker = document.querySelector('.marker-delivery');
            if (!marker) return;

            let posX = 60;
            let posY = 40;

            const moverRepartidor = setInterval(() => {
                if (!simulacionActiva) {
                    clearInterval(moverRepartidor);
                    return;
                }

                // Movimiento aleatorio hacia el destino
                posX += (Math.random() - 0.7) * 5;
                posY += (Math.random() - 0.3) * 3;

                // Limitar posición
                posX = Math.max(10, Math.min(90, posX));
                posY = Math.max(10, Math.min(90, posY));

                marker.style.left = posX + '%';
                marker.style.top = posY + '%';

                // Reducir tiempo gradualmente
                if (tiempoRestante > 0) {
                    tiempoRestante -= 0.5;
                    document.getElementById('eta-time').textContent = Math.ceil(tiempoRestante) + ' min';
                }

                // Si llega al destino
                if (posX <= 35 && posY >= 65) {
                    clearInterval(moverRepartidor);
                    if (simulacionActiva) {
                        pedidoEntregado();
                    }
                }
            }, 2000);

            intervalosActivos.push(moverRepartidor);
        }

        // 5. MODIFICAR en seguimiento.html - Función confirmarCancelacion() mejorada
        function confirmarCancelacion() {
            const metodoPago = document.getElementById('metodo-pago').textContent;

            // Detener todas las simulaciones
            detenerSimulaciones();

            cerrarModal('modal-cancelacion');

            // Actualizar estado
            document.getElementById('estado-pedido').textContent = 'Cancelado';
            document.getElementById('estado-pedido').style.color = '#e74c3c';

            // Mensaje según método de pago
            let mensaje = 'Pedido cancelado exitosamente.';
            if (metodoPago.includes('Tarjeta')) {
                mensaje += ' La devolución será procesada en 3-5 días hábiles.';
            }

            // Marcar timeline como cancelado
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('active');
                if (!item.classList.contains('completed')) {
                    item.style.opacity = '0.5';
                }
            });

            // Mostrar botón para volver al formulario
            const actionButtons = document.querySelector('.action-buttons');
            actionButtons.innerHTML = `
        <button class="btn btn-primary" onclick="volverAlFormulario()">
            <i class="bi bi-arrow-left"></i> Volver al Formulario
        </button>
        <button class="btn btn-outline-primary" onclick="volverAlCarrito()">
            <i class="bi bi-cart"></i> Volver al Carrito
        </button>
    `;

            mostrarModalConfirmacion('Pedido Cancelado', mensaje);
        }

        // 6. NUEVA FUNCIÓN en seguimiento.html - Volver al formulario con datos guardados
        function volverAlFormulario() {
            // Los datos ya están guardados en localStorage, solo redirigir
            window.location.href = 'envio.html';
        }

        // 7. NUEVA FUNCIÓN en seguimiento.html - Volver al carrito
        function volverAlCarrito() {
            window.location.href = 'carrito.html';
        }

        // 8. MODIFICAR en seguimiento.html - Función pedidoEntregado() mejorada
        function pedidoEntregado() {
            if (!simulacionActiva) return;

            estadoActual = 4;
            document.getElementById('estado-pedido').textContent = 'Entregado';
            document.getElementById('estado-pedido').style.color = '#27ae60';

            // Completar entrega
            const stepEntrega = document.getElementById('step-entrega');
            stepEntrega.classList.remove('active');
            stepEntrega.classList.add('completed');
            stepEntrega.querySelector('.timeline-icon').innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            stepEntrega.querySelector('.timeline-time').textContent = 'Completado';

            // Actualizar ETA
            document.getElementById('eta-time').textContent = '¡Entregado!';
            document.querySelector('.eta-label').textContent = 'Pedido completado exitosamente';
            document.querySelector('.eta-info').style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';

            // Limpiar carrito ya que el pedido fue exitoso
            localStorage.removeItem('carritoYummy');
            localStorage.removeItem('carritoTotal');

            // Mostrar botones finales
            const actionButtons = document.querySelector('.action-buttons');
            actionButtons.innerHTML = `
        <button class="btn btn-primary" onclick="hacerNuevoPedido()">
            <i class="bi bi-plus-circle"></i> Hacer Nuevo Pedido
        </button>
        <button class="btn btn-outline-primary" onclick="descargarRecibo()">
            <i class="bi bi-download"></i> Descargar Recibo
        </button>
    `;

            // Detener simulaciones
            detenerSimulaciones();

            mostrarNotificacion('¡Pedido entregado exitosamente! Gracias por elegir Diamonds Coffee', 'success');
        }

        // 9. NUEVA FUNCIÓN en seguimiento.html - Hacer nuevo pedido
        function hacerNuevoPedido() {
            // Limpiar todos los datos del pedido anterior
            localStorage.removeItem('datosPedidoActual');
            localStorage.removeItem('carritoYummy');
            localStorage.removeItem('carritoTotal');

            // Redirigir al menú principal o carrito
            window.location.href = 'carrito.html';
        }

        // 10. NUEVA FUNCIÓN en seguimiento.html - Descargar recibo (simulado)
        function descargarRecibo() {
            mostrarNotificacion('Descargando recibo... (Función simulada)', 'info');
        }

        

        // 13. MODIFICAR en seguimiento.html - Función para verificar si hay carrito activo
        function verificarEstadoCarrito() {
            const carrito = JSON.parse(localStorage.getItem('carritoYummy') || '[]');
            const backButton = document.querySelector('.back-button');

            if (carrito.length === 0) {
                // Si no hay carrito, cambiar el botón para ir al menú
                backButton.href = 'index.html'; // o la página principal
                backButton.innerHTML = '<i class="bi bi-arrow-left"></i> Volver al Menú';
            }
        }

        // 14. MODIFICAR en seguimiento.html - Actualizar inicializarSeguimiento()
        function inicializarSeguimiento() {
            // Verificar estado del carrito
            verificarEstadoCarrito();

            // Cargar datos del pedido actual
            cargarDatosPedido();

            // NUEVO: Asegurar que el estado inicial sea 1 (Confirmado)
            estadoActual = 1;

            // NUEVO: Asegurar que el botón de cancelar esté visible al inicio
            document.getElementById('btn-cancelar').style.display = 'inline-block';

            // Resto del código existente...
            const ahora = new Date();
            const carrito = JSON.parse(localStorage.getItem('carritoYummy') || '[]');
            let total = localStorage.getItem('carritoTotal') || '19.98';
            total = parseFloat(total) + 1.5; // Agregar costo de envío
            document.getElementById('total-pedido').textContent = `$${total}`;
        }


        function cargarDatosPedido() {
            const datosPedido = JSON.parse(localStorage.getItem('datosPedidoActual') || '{}');
            const carrito = JSON.parse(localStorage.getItem('carritoYummy') || '[]');

            if (datosPedido.numeroPedido) {
                // Actualizar número de pedido
                document.querySelector('.pedido-id').textContent = `Pedido #${datosPedido.numeroPedido}`;

                // Actualizar fecha
                const fecha = new Date(datosPedido.fechaPedido);
                document.getElementById('fecha-pedido').textContent = fecha.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Actualizar método de pago
                document.getElementById('metodo-pago').textContent = datosPedido.metodoPago;

                // Actualizar notificación de efectivo
                const notificacionEfectivo = document.getElementById('notificacion-efectivo');
                if (datosPedido.metodoPago === 'Efectivo') {
                    notificacionEfectivo.style.display = 'block';
                    if (datosPedido.montoEfectivo) {
                        const mensaje = notificacionEfectivo.querySelector('.notification-message');
                        mensaje.innerHTML = `Se ha notificado al repartidor que el pago será en efectivo. 
                Has indicado que pagarás con: <strong>$${datosPedido.montoEfectivo}</strong>. 
                Total del pedido: <strong>$${localStorage.getItem('carritoTotal') || '19.98'}</strong>`;
                    }
                } else {
                    notificacionEfectivo.style.display = 'none';
                }
            }

            // Actualizar resumen del pedido si hay carrito
            if (carrito.length > 0) {
                actualizarResumenPedido(carrito);
            }
        }

        function actualizarResumenPedido(carrito) {
            const resumenContainer = document.getElementById('order-summary');
            const itemsContainer = resumenContainer.querySelector('.order-item').parentElement;

            // Limpiar items existentes (excepto el total)
            const items = itemsContainer.querySelectorAll('.order-item');
            items.forEach((item, index) => {
                if (index < items.length - 1) { // No eliminar el último (total)
                    item.remove();
                }
            });

            // Agregar items del carrito
            const totalItem = itemsContainer.querySelector('.order-item:last-child');
            carrito.forEach(producto => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                itemDiv.innerHTML = `
            <span>${producto.cantidad}x ${producto.nombre}</span>
            <span>$${(producto.precio * producto.cantidad).toFixed(2)}</span>
        `;
                itemsContainer.insertBefore(itemDiv, totalItem);
            });

            // Agregar costo de envío
            const envioDiv = document.createElement('div');
            envioDiv.className = 'order-item';
            envioDiv.innerHTML = `
        <span>Costo de envío</span>
        <span>$1.50</span>
    `;
            itemsContainer.insertBefore(envioDiv, totalItem);

            // Actualizar total
            let total = localStorage.getItem('carritoTotal') || '19.98';

            total= parseFloat(total)+1.5; // Agregar costo de envío

            totalItem.innerHTML = `
        <span>Total</span>
        <span>$${total}</span>
    `;

            // Actualizar totales en la página
            document.getElementById('total-pedido').textContent = `$${total}`;
        }


        // Inicializar la página
        document.addEventListener('DOMContentLoaded', function () {
            inicializarSeguimiento();
            simularProgresoPedido();
            actualizarTiempoRestante();
        });

        function simularProgresoPedido() {
            // Simular el avance del pedido cada 30 segundos
            setTimeout(() => {
                if (estadoActual === 1) {
                    avanzarAPreparacion();
                }
            }, 5000); // 5 segundos para demo

            setTimeout(() => {
                if (estadoActual === 2) {
                    avanzarAEntrega();
                }
            }, 15000); // 15 segundos para demo
        }

        function avanzarAPreparacion() {
            estadoActual = 2;
            document.getElementById('estado-pedido').textContent = 'En Preparación';

            // Activar step de preparación
            const stepPreparacion = document.getElementById('step-preparacion');
            stepPreparacion.classList.add('active');

            // NUEVO: Ocultar botón de cancelar cuando pasa a preparación
            document.getElementById('btn-cancelar').style.display = 'none';

            // Mostrar notificación
            mostrarNotificacion('El personal de cocina ha iniciado la preparación de tu pedido', 'success');

            // Notificar al sistema de inventario (simulado)
            simularNotificacionInventario();
        }

        function avanzarAEntrega() {
            estadoActual = 3;
            document.getElementById('estado-pedido').textContent = 'En Camino';
            document.getElementById('estado-pedido').style.color = '#27ae60';

            // Completar preparación
            const stepPreparacion = document.getElementById('step-preparacion');
            stepPreparacion.classList.remove('active');
            stepPreparacion.classList.add('completed');
            stepPreparacion.querySelector('.timeline-icon').innerHTML = '<i class="bi bi-check-circle-fill"></i>';

            // Activar entrega
            const stepEntrega = document.getElementById('step-entrega');
            stepEntrega.classList.add('active');
            stepEntrega.querySelector('.timeline-time').textContent = 'Ahora - En progreso';

            // Asignar repartidor
            asignarRepartidor();

            // Mostrar sección de delivery
            document.getElementById('delivery-section').style.display = 'grid';
            document.getElementById('btn-contactar').style.display = 'inline-block';

            // Cambiar ETA
            tiempoRestante = 15;
            document.getElementById('eta-time').textContent = tiempoRestante + ' min';

            // Ocultar botón de cancelar
            document.getElementById('btn-cancelar').style.display = 'none';

            mostrarNotificacion('¡Tu pedido está en camino! Repartidor asignado', 'success');
        }

        function asignarRepartidor() {
            // Simular asignación desde Motoexpress
            const repartidores = [
                { nombre: 'Juan Rodríguez', iniciales: 'JR', rating: '4.8', entregas: '127', telefono: '0987-654-321' },
                { nombre: 'Ana López', iniciales: 'AL', rating: '4.9', entregas: '203', telefono: '0988-123-456' },
                { nombre: 'Carlos Vera', iniciales: 'CV', rating: '4.7', entregas: '89', telefono: '0989-987-654' }
            ];

            const vehiculos = [
                { tipo: 'Motocicleta', placa: 'ABC-1234', color: 'Rojo' },
                { tipo: 'Motocicleta', placa: 'BIC-5678', color: 'Azul' },
                { tipo: 'Motocicleta', placa: 'XYZ-9876', color: 'Negro' }
            ];

            const repartidor = repartidores[Math.floor(Math.random() * repartidores.length)];
            const vehiculo = vehiculos[Math.floor(Math.random() * vehiculos.length)];

            // Actualizar información del repartidor
            document.getElementById('delivery-avatar').textContent = repartidor.iniciales;
            document.getElementById('delivery-name').textContent = repartidor.nombre;
            document.getElementById('delivery-rating').textContent = `⭐ ${repartidor.rating} (${repartidor.entregas} entregas)`;
            document.getElementById('delivery-phone').textContent = `📞 ${repartidor.telefono}`;

            // Actualizar información del vehículo
            document.getElementById('vehicle-type').textContent = vehiculo.tipo;
            document.getElementById('vehicle-plate').textContent = vehiculo.placa;
            document.getElementById('vehicle-color').textContent = vehiculo.color;

            // Actualizar timeline con información del repartidor
            const stepEntrega = document.getElementById('step-entrega');
            const detalles = stepEntrega.querySelector('.timeline-details');
            detalles.innerHTML = `
                <strong>Repartidor:</strong> ${repartidor.nombre}<br>
                <strong>Vehículo:</strong> ${vehiculo.tipo} ${vehiculo.color}<br>
                <strong>Placa:</strong> ${vehiculo.placa}<br>
                <strong>Conexión Motoexpress:</strong> ✅ Activa
            `;

            repartidorAsignado = true;
            simularMovimientoRepartidor();
        }

        function simularMovimientoRepartidor() {
            // Simular movimiento del repartidor en el mapa
            const marker = document.querySelector('.marker-delivery');
            let posX = 60;
            let posY = 40;

            const moverRepartidor = setInterval(() => {
                // Movimiento aleatorio hacia el destino
                posX += (Math.random() - 0.7) * 5;
                posY += (Math.random() - 0.3) * 3;

                // Limitar posición
                posX = Math.max(10, Math.min(90, posX));
                posY = Math.max(10, Math.min(90, posY));

                marker.style.left = posX + '%';
                marker.style.top = posY + '%';

                // Reducir tiempo gradualmente
                if (tiempoRestante > 0) {
                    tiempoRestante -= 0.5;
                    document.getElementById('eta-time').textContent = Math.ceil(tiempoRestante) + ' min';
                }

                // Si llega al destino
                if (posX <= 35 && posY >= 65) {
                    clearInterval(moverRepartidor);
                    pedidoEntregado();
                }
            }, 2000);
        }

        function pedidoEntregado() {
            if (!simulacionActiva) return;

            estadoActual = 4;
            document.getElementById('estado-pedido').textContent = 'Entregado';
            document.getElementById('estado-pedido').style.color = '#27ae60';

            // Completar entrega
            const stepEntrega = document.getElementById('step-entrega');
            stepEntrega.classList.remove('active');
            stepEntrega.classList.add('completed');
            stepEntrega.querySelector('.timeline-icon').innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            stepEntrega.querySelector('.timeline-time').textContent = 'Completado';

            // Actualizar ETA
            document.getElementById('eta-time').textContent = '¡Entregado!';
            document.querySelector('.eta-label').textContent = 'Pedido completado exitosamente';
            document.querySelector('.eta-info').style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';

            // Limpiar carrito ya que el pedido fue exitoso
            localStorage.removeItem('carritoYummy');
            localStorage.removeItem('carritoTotal');

            // MODIFICADO: Mostrar botones finales incluyendo regreso al menú principal
            const actionButtons = document.querySelector('.action-buttons');
            actionButtons.innerHTML = `
        <button class="btn btn-primary" onclick="volverAlMenuPrincipal()">
            <i class="bi bi-house-fill"></i> Volver al Menú Principal
        </button>
        <button class="btn btn-outline-primary" onclick="hacerNuevoPedido()">
            <i class="bi bi-plus-circle"></i> Hacer Nuevo Pedido
        </button>
        <button class="btn btn-outline-primary" onclick="descargarRecibo()">
            <i class="bi bi-download"></i> Descargar Recibo
        </button>
    `;

            // Detener simulaciones
            detenerSimulaciones();

            mostrarNotificacion('¡Pedido entregado exitosamente! Gracias por elegir Diamonds Coffee', 'success');
        }

        function volverAlMenuPrincipal() {
            // Limpiar todos los datos del pedido anterior
            localStorage.removeItem('datosPedidoActual');
            localStorage.removeItem('carritoYummy');
            localStorage.removeItem('carritoTotal');

            // Mostrar mensaje de despedida
            mostrarNotificacion('¡Gracias por tu compra! Te esperamos pronto.', 'success');

            // Redirigir al menú principal después de un breve delay
            setTimeout(() => {
                window.location.href = 'index.html'; // Cambia por la ruta de tu menú principal
            }, 1500);
        }

        function actualizarTiempoRestante() {
            // Actualizar cada minuto el tiempo restante
            setInterval(() => {
                if (tiempoRestante > 0 && estadoActual < 4) {
                    const ahora = new Date();
                    const tiempoTranscurrido = Math.floor((ahora.getTime() - Date.now()) / 60000);
                    // Lógica de actualización de tiempo más realista podría ir aquí
                }
            }, 60000);
        }

        function simularNotificacionInventario() {
            // Simular conexión con sistema de inventario
            setTimeout(() => {
                console.log('🔄 Conexión con sistema de inventario activa');
                console.log('📦 Ingredientes verificados y reservados');
                console.log('✅ Stock actualizado automáticamente');
            }, 2000);
        }

        function contactarRepartidor() {
            if (repartidorAsignado) {
                const telefono = document.getElementById('delivery-phone').textContent.replace('📞 ', '');
                mostrarNotificacion(`Contactando al repartidor al ${telefono}...`, 'info');

                // Simular llamada
                setTimeout(() => {
                    mostrarNotificacion('Llamada conectada. El repartidor está en camino.', 'success');
                }, 3000);
            }
        }

        function verResumenPedido() {
            const resumen = document.getElementById('order-summary');
            if (resumen.style.display === 'none') {
                resumen.style.display = 'block';
                resumen.scrollIntoView({ behavior: 'smooth' });
            } else {
                resumen.style.display = 'none';
            }
        }

        function cancelarPedido() {
            // Solo permitir cancelación en la primera etapa (Pedido Confirmado)
            if (estadoActual > 1) {
                let mensajeError = '';
                if (estadoActual === 2) {
                    mensajeError = 'No se puede cancelar el pedido. Ya está en preparación.';
                } else if (estadoActual >= 3) {
                    mensajeError = 'No se puede cancelar el pedido. Ya está en camino.';
                }

                mostrarNotificacion(mensajeError, 'error');
                return;
            }

            // Si está en estado 1 (Confirmado), permitir cancelación
            document.getElementById('modal-cancelacion').style.display = 'flex';
        }

        function confirmarCancelacion() {
            const metodoPago = document.getElementById('metodo-pago').textContent;

            // Detener todas las simulaciones
            detenerSimulaciones();

            cerrarModal('modal-cancelacion');

            // Actualizar estado
            document.getElementById('estado-pedido').textContent = 'Cancelado';
            document.getElementById('estado-pedido').style.color = '#e74c3c';

            // Mensaje según método de pago
            let mensaje = 'Pedido cancelado exitosamente.';
            if (metodoPago.includes('Tarjeta')) {
                mensaje += ' La devolución será procesada en 3-5 días hábiles.';
            }

            // Marcar timeline como cancelado
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('active');
                if (!item.classList.contains('completed')) {
                    item.style.opacity = '0.5';
                }
            });

            // MODIFICADO: Mostrar botones incluyendo regreso al menú principal
            const actionButtons = document.querySelector('.action-buttons');
            actionButtons.innerHTML = `
        <button class="btn btn-primary" onclick="volverAlMenuPrincipal()">
            <i class="bi bi-house-fill"></i> Volver al Menú Principal
        </button>
        <button class="btn btn-outline-primary" onclick="volverAlFormulario()">
            <i class="bi bi-arrow-left"></i> Volver al Formulario
        </button>
        <button class="btn btn-outline-primary" onclick="volverAlCarrito()">
            <i class="bi bi-cart"></i> Volver al Carrito
        </button>
    `;

            mostrarModalConfirmacion('Pedido Cancelado', mensaje);
        }


        function mostrarNotificacion(mensaje, tipo) {
            // Crear notificación temporal
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo === 'success' ? 'success' : tipo === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
            notificacion.style.position = 'fixed';
            notificacion.style.top = '20px';
            notificacion.style.right = '20px';
            notificacion.style.zIndex = '1050';
            notificacion.style.minWidth = '300px';
            notificacion.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

            document.body.appendChild(notificacion);

            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (notificacion.parentElement) {
                    notificacion.remove();
                }
            }, 5000);
        }

        function mostrarModalConfirmacion(titulo, mensaje) {
            document.getElementById('modal-title').textContent = titulo;
            document.getElementById('modal-message').textContent = mensaje;
            document.getElementById('modal-confirmacion').style.display = 'flex';
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Simular actualizaciones en tiempo real del personal
        function simularActualizacionesPersonal() {
            const actualizaciones = [
                { tiempo: 8000, mensaje: 'María (Recepción): Pedido verificado y enviado a cocina' },
                { tiempo: 12000, mensaje: 'Carlos (Barista): Iniciando preparación de bebidas' },
                { tiempo: 18000, mensaje: 'Ana (Cocina): Preparando acompañamientos' },
                { tiempo: 25000, mensaje: 'Carlos (Barista): Bebidas listas, empacando pedido' }
            ];

            actualizaciones.forEach(update => {
                setTimeout(() => {
                    console.log(`📢 ${update.mensaje}`);
                    // Aquí podrías mostrar estas actualizaciones en la interfaz
                }, update.tiempo);
            });
        }

        // Inicializar simulaciones
        simularActualizacionesPersonal();

        // Simular conexión con Motoexpress cada 30 segundos
        setInterval(() => {
            if (repartidorAsignado) {
                console.log('🔗 Sincronización con Motoexpress: Ubicación actualizada');
            }
        }, 30000);

        // Manejar clics fuera del modal para cerrarlo
        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        function limpiarDatosPedido() {
            localStorage.removeItem('datosPedidoActual');
            localStorage.removeItem('carritoYummy');
            localStorage.removeItem('carritoTotal');
            console.log('Datos del pedido limpiados');
        }
    </script>
</body>

</html>